<!DOCTYPE html>
<html lang="no">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üöõ Registrer Avganger - Transportsystem</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      color: #333;
      font-size: 16px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 320px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      position: sticky;
      top: 10px;
      height: fit-content;
    }

    .main-content {
      flex: 1;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 25px 20px;
      text-align: center;
      border-radius: 10px 10px 0 0;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .header p {
      font-size: 1rem;
      opacity: 0.9;
    }

    .section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 25px;
      border-left: 5px solid #3498db;
      margin-bottom: 25px;
    }

    .section h2 {
      color: #2c3e50;
      font-size: 1.6rem;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #2c3e50;
      display: block;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .btn-danger, .btn-secondary, .btn-success {
      width: auto;
      min-width: 120px;
    }

    .search-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
    }

    #searchInput, #filterDestination {
      padding: 12px 16px;
      width: 100%;
      max-width: 300px;
      border: 2px solid #3498db;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      position: relative;
    }

    th::after {
      content: "‚ÜïÔ∏è";
      position: absolute;
      right: 8px;
      opacity: 0.3;
      font-size: 12px;
    }

    th.sort-asc::after { content: "‚Üë"; opacity: 1; }
    th.sort-desc::after { content: "‚Üì"; opacity: 1; }

    td {
      padding: 14px;
      border-bottom: 1px solid #ecf0f1;
      font-size: 0.95rem;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-buttons .btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      min-width: 70px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-top: 4px solid #3498db;
    }

    .stat-card.type-tog { border-top-color: #090deb; }
    .stat-card.type-bil { border-top-color: #f312e8; }
    .stat-card.type-tralle { border-top-color: #3498db; }
    .stat-card.type-modul { border-top-color: #9b59b6; }
    .stat-card.dest { border-top-color: #16a085; }

    .stat-number {
      font-size: 1.6rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .stat-label {
      color: #7f8c8d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.8rem;
    }

    #toast {
      visibility: hidden;
      min-width: 300px;
      margin-left: -150px;
      background: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 30px;
      font-size: 1rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s ease, bottom 0.3s ease;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }

    .type-icon {
      margin-right: 6px;
      font-size: 1.2em;
    }

    /* --- MOBILTILPASNING --- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        font-size: 15px;
      }

      .container {
        flex-direction: column;
        gap: 10px;
      }

      .sidebar {
        width: 100%;
        position: static;
        padding: 15px;
        margin-bottom: 10px;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .section {
        padding: 20px;
      }

      .section h2 {
        font-size: 1.4rem;
      }

      .form-group label {
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 1rem;
        padding: 12px;
      }

      .btn {
        font-size: 0.95rem;
        padding: 10px;
      }

      .search-container {
        gap: 10px;
      }

      #searchInput, #filterDestination {
        max-width: 100%;
        font-size: 1rem;
      }

      th, td {
        padding: 10px 8px;
        font-size: 0.9rem;
      }

      .action-buttons .btn {
        font-size: 0.8rem;
        padding: 5px 8px;
      }

      .stat-number {
        font-size: 1.4rem;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .button-group .btn {
        flex: 1;
        min-width: 45%;
        font-size: 0.85rem;
        padding: 10px;
      }
    }

    /* --- UTSKRIFT --- */
    @media print {
      body {
        background: white;
        padding: 0;
        color: black;
        font-size: 12pt;
      }
      .container {
        max-width: 100%;
        box-shadow: none;
        flex-direction: column;
      }
      .sidebar, .button-group, .stats-container, .search-container {
        display: none;
      }
      .section h2 {
        font-size: 1.5rem;
      }
      table {
        font-size: 12pt;
        border: 1px solid #000;
      }
      th, td {
        padding: 8px;
        border-bottom: 1px solid #000;
      }
      th {
        background-color: #eee;
        color: black;
        font-weight: bold;
      }
      tr:hover {
        background: none;
      }
      .action-buttons {
        display: none;
      }
      .header {
        background: white;
        color: black;
        border-bottom: 2px solid #000;
      }
      .print-footer {
        text-align: center;
        font-size: 10pt;
        color: #333;
        margin-top: 30px;
        padding-top: 10px;
        border-top: 1px solid #000;
      }
    }

    /* --- TILBAKE TIL TOPP KNAPP --- */
    .back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2c3e50;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 999;
    }

    .back-to-top.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidepanel -->
    <div class="sidebar">
      <h1 style="font-size: 1.6rem; color: #2c3e50; text-align: center; margin-bottom: 15px;">üöõ Registrer Avgang</h1>
      <form id="departureForm">
        <div class="form-group">
          <label for="unitNumber">Enhetsnummer *</label>
          <input type="text" id="unitNumber" required placeholder="F.eks. TOG001">
        </div>
        <div class="form-group">
          <label for="destination">Destinasjon *</label>
          <select id="destination" required>
            <option value="">Velg destinasjon</option>
            <option value="TRONDHEIM">TRONDHEIM</option>
            <option value="√ÖLESUND">√ÖLESUND</option>
            <option value="MOLDE">MOLDE</option>
            <option value="F√òRDE">F√òRDE</option>
            <option value="HAUGESUND">HAUGESUND</option>
            <option value="STAVANGER">STAVANGER</option>
          </select>
        </div>
        <div class="form-group">
          <label for="time">Avgangstid *</label>
          <input type="time" id="time" required>
        </div>
        <div class="form-group">
          <label for="gate">Luke *</label>
          <input type="text" id="gate" required placeholder="F.eks. A1, B2">
        </div>
        <div class="form-group">
          <label for="type">Type *</label>
          <select id="type" required>
            <option value="">Velg type</option>
            <option value="Tog">Tog</option>
            <option value="Bil">Bil</option>
            <option value="Tralle">Tralle</option>
            <option value="Modul">Modul</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status *</label>
          <select id="status" required>
            <option value="">Velg status</option>
            <option value="LEVERT">LEVERT</option>
            <option value="LAGER">LAGER</option>
            <option value="planlaget">Planlaget</option>
            <option value="LASTER N√Ö">LASTER N√Ö</option>
          </select>
        </div>
        <div class="form-group">
          <label for="comment">Kommentar</label>
          <textarea id="comment" placeholder="F.eks. Forsinket, laster n√•..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">‚úÖ Registrer Avgang</button>

        <!-- üîΩ NY: Synkroniseringsstatus -->
        <div id="syncStatus" style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #27ae60; display: flex; align-items: center; justify-content: center; gap: 6px;">
          <span>üü¢</span> <span>Automatisk lagring</span>
        </div>
      </form>
    </div>

    <!-- Hovedinnhold -->
    <div class="main-content">
      <div class="header">
        <h1>üöõ Transportsystem</h1>
        <p>Registrering og oversikt over alle avganger</p>
      </div>

      <section class="section">
        <h2><span class="icon">üìã</span> Oversikt over Avganger</h2>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="S√∏k p√• enhetsnummer, destinasjon...">
          <select id="filterDestination">
            <option value="">Alle destinasjoner</option>
            <option value="TRONDHEIM">TRONDHEIM</option>
            <option value="√ÖLESUND">√ÖLESUND</option>
            <option value="MOLDE">MOLDE</option>
            <option value="F√òRDE">F√òRDE</option>
            <option value="HAUGESUND">HAUGESUND</option>
            <option value="STAVANGER">STAVANGER</option>
          </select>
        </div>
        <div class="table-container">
          <table id="departuresTable">
            <thead>
              <tr>
                <th data-sort="unitNumber">Enhetsnummer</th>
                <th data-sort="destination">Destinasjon</th>
                <th data-sort="time">Tid</th>
                <th data-sort="gate">Luke</th>
                <th data-sort="type">Type</th>
                <th data-sort="status">Status</th>
                <th data-sort="comment">Kommentar</th>
                <th>Handlinger</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Systemhandlinger -->
      <section class="section">
        <h2><span class="icon">‚öôÔ∏è</span> Systemhandlinger</h2>
        <div class="button-group">
          <button class="btn btn-danger" onclick="clearAllDepartures()">üóëÔ∏è T√∏m alle</button>
          <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Skriv ut</button>
          <button class="btn btn-success" onclick="exportToCSV()">üìÑ CSV</button>
          <button class="btn btn-primary" onclick="backupData()">üíæ Backup</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üìÇ Last opp</button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromJSON(this)">
        </div>
      </section>
    </div>
  </div>

  <!-- Tilbake til topp -->
  <div class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">üîù</div>

  <div id="toast"></div>
<script>
  // --- Konfig: GitHub-URL til datafilen ---
  const DATA_URL = 'https://raw.githubusercontent.com/sayler87/Latliste/main/data.json';
  const DATA_UPDATE_INTERVAL = 5000; // Oppdater hver 5. sekund

  // --- Variabler ---
  let departures = JSON.parse(localStorage.getItem('departures')) || [];
  let editingIndex = null;
  

  const form = document.getElementById('departureForm');
  const searchInput = document.getElementById('searchInput');
  const filterDestination = document.getElementById('filterDestination');
  const tableBody = document.querySelector('#departuresTable tbody');
  const toast = document.getElementById('toast');
  const backToTop = document.querySelector('.back-to-top');

  const typeIcons = {
    Tog: 'üöÇ',
    Bil: 'üöó',
    Tralle: 'üõí',
    Modul: 'üì¶'
  };

  let currentSort = { key: null, asc: true };

  // --- Hent data fra GitHub ---
  function displayDepartures() {
  const tbody = document.querySelector('#departuresTable tbody');
  tbody.innerHTML = departures.map(d => `
    <tr>
      <td>${d.unitNumber}</td>
      <td>${d.destination}</td>
      <td>${d.time}</td>
      <td>${d.gate}</td>
      <td>${d.type}</td>
      <td>${d.status}</td>
      <td>${d.comment || '<em>Ingen</em>'}</td>
      <td><button onclick="deleteDeparture(${d.id})">üóëÔ∏è</button></td>
    </tr>
  `).join('');
}

  // --- Lagre data til GitHub (via GitHub Actions eller manuelt) ---
  async function saveData(newDepartures) {
    departures = newDepartures;
    displayDepartures();
    showToast('Data lagret lokalt ‚Äì last opp data.json til GitHub for √• dele', 'info');
    // ‚ö†Ô∏è Viktig: Du m√• manuelt laste opp data.json til GitHub, eller bruke GitHub Actions/API
  }

  // --- Sett dagens tid ---
  document.getElementById('time').value = new Date().toTimeString().slice(0, 5);

  // --- Store bokstaver ---
  document.getElementById('unitNumber').addEventListener('input', e => {
    e.target.value = e.target.value.toUpperCase();
  });

  // --- Toast ---
  function showToast(message, type = 'info') {
    const colors = { success: '#27ae60', error: '#e74c3c', info: '#3498db', delete: '#e74c3c', edit: '#f39c12' };
    toast.textContent = message;
    toast.style.backgroundColor = colors[type] || '#333';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // --- Oppdater tabell ---
  function displayDepartures() {
    const term = searchInput.value.toLowerCase();
    const dest = filterDestination.value;
    let filtered = departures.filter(d =>
      (term === '' || d.unitNumber.toLowerCase().includes(term) || d.destination.toLowerCase().includes(term)) &&
      (dest === '' || d.destination === dest)
    );

    if (currentSort.key) {
      filtered.sort((a, b) => {
        let av = a[currentSort.key] || '', bv = b[currentSort.key] || '';
        if (currentSort.key === 'time') av = av.replace(':', ''), bv = bv.replace(':', '');
        const res = av < bv ? -1 : av > bv ? 1 : 0;
        return currentSort.asc ? res : -res;
      });
    }

    tableBody.innerHTML = filtered.map(d => {
      const tc = d.type === 'Tog' ? '#e74c3c' : d.type === 'Bil' ? '#f312e8' : d.type === 'Tralle' ? '#3498db' : '#9b59b6';
      const sc = d.status === 'LEVERT' ? '#27ae60' : d.status === 'LAGER' ? '#3498db' : '#f39c12';
      return `
        <tr>
          <td>${d.unitNumber}</td>
          <td>${d.destination}</td>
          <td>${d.time}</td>
          <td>${d.gate}</td>
          <td><span class="type-icon">${typeIcons[d.type]}</span><span style="color:${tc};font-weight:bold">${d.type}</span></td>
          <td><span style="color:${sc};font-weight:bold">${d.status}</span></td>
          <td>${d.comment || '<em>Ingen</em>'}</td>
          <td class="action-buttons">
            <button class="btn btn-secondary" onclick="editDeparture(${d.id})">‚úèÔ∏è</button>
            <button class="btn btn-danger" onclick="deleteDeparture(${d.id})">üóëÔ∏è</button>
          </td>
        </tr>`;
    }).join('');

    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
      if (th.dataset.sort === currentSort.key) th.classList.add(currentSort.asc ? 'sort-asc' : 'sort-desc');
    });
  }

  // --- Sortering ---
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.sort;
      currentSort.asc = currentSort.key === key ? !currentSort.asc : true;
      currentSort.key = key;
      displayDepartures();
    });
  });

  // --- Skjema ---
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = {
  id: Date.now(),
  unitNumber: document.getElementById('unitNumber').value.trim().toUpperCase(),
  destination: document.getElementById('destination').value,
  time: document.getElementById('time').value,
  gate: document.getElementById('gate').value.trim(),
  type: document.getElementById('type').value,
  status: document.getElementById('status').value,
  comment: document.getElementById('comment').value.trim() || null
};
// Legg til i arrayen
     departures.push(data);
      // Lagre og oppdater
    localStorage.setItem('departures', JSON.stringify(departures));
    displayDepartures(); // üî• Viktig: Oppdater tabellen

    // Tilbakestill skjema
    form.reset();
    showToast('Avgang registrert!');



    if (Object.values(data).some(v => v === '' && v !== null)) {
      showToast('Vennligst fyll ut alle obligatoriske felt.', 'info');
      return;
    }

    if (editingIndex === null && departures.some(d => d.unitNumber === data.unitNumber)) {
      showToast(`Enhetsnummer ${data.unitNumber} eksisterer allerede!`, 'info');
      return;
    }

    if (editingIndex !== null) {
      departures[editingIndex] = data;
      editingIndex = null;
      form.querySelector('button[type="submit"]').textContent = '‚úÖ Registrer Avgang';
      showToast('Oppdatert!', 'edit');
    } else {
      departures.push(data);
      showToast('Registrert!', 'success');
    }

    await saveData(departures);
    form.reset();
    document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
  });

  // --- Rediger/slett ---
  window.editDeparture = (id) => {
    const idx = departures.findIndex(d => d.id === id);
    if (idx === -1) return;
    const d = departures[idx];
    Object.keys(d).forEach(k => {
      if (document.getElementById(k)) document.getElementById(k).value = d[k];
    });
    editingIndex = idx;
    form.querySelector('button[type="submit"]').textContent = 'üîÅ Oppdater';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.deleteDeparture = (id) => {
    if (confirm('Slette denne avgangen?')) {
      departures = departures.filter(d => d.id !== id);
      saveData(departures);
      showToast('Slettet!', 'delete');
    }
  };

  window.clearAllDepartures = () => {
    if (departures.length === 0) {
      showToast('Ingen avganger √• slette.', 'info');
      return;
    }
    if (confirm('Slette ALLE avganger?')) {
      departures = [];
      saveData(departures);
      showToast('Alt t√∏mt!', 'delete');
    }
  };

  // --- Eksport ---
  function exportToCSV() {
    const headers = ['Enhetsnummer','Destinasjon','Tid','Luke','Type','Status','Kommentar'];
    const rows = departures.map(d => [
      d.unitNumber, d.destination, d.time, d.gate, d.type, d.status, d.comment || ''
    ].map(s => `"${s}"`).join(','));
    downloadFile([headers.join(','), ...rows].join('\n'), `avganger_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
    showToast('Eksportert til CSV!', 'success');
  }

  function backupData() {
    downloadFile(JSON.stringify(departures, null, 2), `data.json`, 'application/json');
    showToast('Lagret data.json ‚Äì last den opp til GitHub!', 'info');
  }

  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importFromJSON(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const imported = JSON.parse(e.target.result);
        if (Array.isArray(imported) && imported.every(d => d.id && d.unitNumber && d.destination)) {
          const overwrite = confirm(`Fant ${imported.length} avganger. OK for √• ERSTATTE, Avbryt for √• LEGGE TIL.`);
          if (overwrite) {
            departures = imported;
          } else {
            const existingIds = new Set(departures.map(d => d.id));
            imported.forEach(d => {
              if (!existingIds.has(d.id)) {
                departures.push(d);
              }
            });
          }
          saveData(departures);
          showToast('Data importert!', 'success');
        } else {
          throw new Error('Ugyldig format');
        }
      } catch (err) {
        showToast('Feil ved lesing av JSON-fil!', 'error');
        console.error(err);
      }
    };
    reader.readAsText(file);
    input.value = '';
  }

  // --- Automatisk oppdatering (polling) ---
  setInterval(loadData, DATA_UPDATE_INTERVAL);

  // --- Tilbake til topp ---
  window.addEventListener('scroll', () => {
    backToTop.classList.toggle('show', window.scrollY > 300);
  });

  // --- Init ---
  loadData();
  searchInput.addEventListener('input', displayDepartures);
  filterDestination.addEventListener('change', displayDepartures);
</script>
</body>
</html>